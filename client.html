<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royal Restaurant | Ø±Ø³ØªÙˆØ±Ø§Ù† Ø±ÙˆÛŒØ§Ù„</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { font-family: 'Vazirmatn', sans-serif; }
        :root { --gold: #D4AF37; --gold-light: #F4E4BA; }
        body { background: linear-gradient(135deg, #0D0D0D 0%, #1A1A1A 50%, #0D0D0D 100%); min-height: 100vh; color: white; }
        .gold-gradient { background: linear-gradient(135deg, #D4AF37 0%, #F4E4BA 50%, #D4AF37 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        .gold-border { border: 1px solid rgba(212, 175, 55, 0.3); }
        .btn-gold { background: linear-gradient(135deg, #D4AF37 0%, #B8962D 100%); transition: all 0.3s ease; color: black; font-weight: bold; }
        .btn-gold:hover { background: linear-gradient(135deg, #F4E4BA 0%, #D4AF37 100%); transform: scale(1.02); }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .category-active { background: linear-gradient(135deg, #D4AF37 0%, #B8962D 100%); color: #0D0D0D; }
        input, textarea, select { background: #2D2D2D !important; border: 1px solid rgba(212, 175, 55, 0.3) !important; color: white !important; }
        .modal-backdrop { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="pb-24">
    <header class="fixed top-0 left-0 right-0 z-50 bg-black/95 backdrop-blur-md p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-[#D4AF37] to-[#B8962D] flex items-center justify-center">
                    <i class="fas fa-crown text-black"></i>
                </div>
                <h1 class="text-xl font-bold gold-gradient" data-translate="siteName">Ø±Ø³ØªÙˆØ±Ø§Ù† Ø±ÙˆÛŒØ§Ù„</h1>
            </div>
            <div class="flex gap-3">
                <button onclick="toggleLang()" class="gold-border px-3 rounded-lg"><span id="currLang">ğŸ‡®ğŸ‡·</span></button>
                <button onclick="showCart()" class="relative p-2">
                    <i class="fas fa-shopping-bag text-[#D4AF37] text-xl"></i>
                    <span id="cartBadge" class="absolute -top-1 -right-1 bg-red-500 text-xs w-5 h-5 rounded-full flex items-center justify-center hidden">0</span>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 pt-24">
        <div id="cats" class="flex gap-3 overflow-x-auto scrollbar-hide py-4"></div>
        <div id="prods" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
    </main>

    <nav class="fixed bottom-0 w-full bg-[#1A1A1A] gold-border border-b-0 rounded-t-3xl z-40 p-3 flex justify-around">
        <button onclick="showCart()" class="text-gray-400 hover:text-[#D4AF37] flex flex-col items-center"><i class="fas fa-shopping-cart"></i><span class="text-xs mt-1" data-translate="cart">Ø³Ø¨Ø¯</span></button>
        <button onclick="showOrders()" class="text-gray-400 hover:text-[#D4AF37] flex flex-col items-center"><i class="fas fa-box"></i><span class="text-xs mt-1" data-translate="myOrders">Ø³ÙØ§Ø±Ø´Ø§Øª</span></button>
    </nav>

    <!-- Cart Modal -->
    <div id="cartModal" class="fixed inset-0 z-50 hidden">
        <div class="modal-backdrop absolute inset-0" onclick="closeCart()"></div>
        <div class="absolute bottom-0 w-full bg-[#1A1A1A] rounded-t-3xl gold-border max-h-[85vh] overflow-hidden flex flex-col">
            <div class="p-4 border-b border-white/10 flex justify-between">
                <h3 class="font-bold gold-gradient" data-translate="cart">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</h3>
                <button onclick="closeCart()"><i class="fas fa-times"></i></button>
            </div>
            <div id="cartItems" class="p-4 overflow-y-auto flex-1"></div>
            <div class="p-4 border-t border-white/10">
                <button onclick="showCheckout()" class="w-full btn-gold py-3 rounded-xl font-bold" data-translate="checkout">ØªÚ©Ù…ÛŒÙ„ Ø³ÙØ§Ø±Ø´</button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="modal-backdrop absolute inset-0" onclick="closeCheckout()"></div>
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-[#1A1A1A] w-full max-w-lg rounded-2xl gold-border p-4 relative">
                <h3 class="font-bold gold-gradient mb-4" data-translate="orderForm">ÙØ±Ù… Ø³ÙØ§Ø±Ø´</h3>
                <form id="orderForm" class="space-y-3">
                    <div class="grid grid-cols-2 gap-3">
                        <input type="text" name="firstName" placeholder="Ù†Ø§Ù…" required class="w-full p-3 rounded-xl">
                        <input type="text" name="lastName" placeholder="Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ" required class="w-full p-3 rounded-xl">
                    </div>
                    <input type="tel" name="phone" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³" required class="w-full p-3 rounded-xl">
                    <textarea name="address" placeholder="Ø¢Ø¯Ø±Ø³ Ø¯Ù‚ÛŒÙ‚" required class="w-full p-3 rounded-xl"></textarea>
                    <div class="flex gap-2">
                        <input type="text" name="location" id="locInput" placeholder="Ù„ÙˆÚ©ÛŒØ´Ù†" readonly class="flex-1 p-3 rounded-xl">
                        <button type="button" onclick="getLoc()" class="btn-gold px-4 rounded-xl"><i class="fas fa-map-marker-alt"></i></button>
                    </div>
                    <select name="contactMethod" class="w-full p-3 rounded-xl">
                        <option value="whatsapp">ÙˆØ§ØªØ³Ø§Ù¾</option>
                        <option value="telegram">ØªÙ„Ú¯Ø±Ø§Ù…</option>
                    </select>
                    <select name="deliveryType" class="w-full p-3 rounded-xl">
                        <option value="delivery">Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Ù¾ÛŒÚ©</option>
                        <option value="pickup">ØªØ­ÙˆÛŒÙ„ Ø­Ø¶ÙˆØ±ÛŒ</option>
                    </select>
                    <button type="submit" id="payBtn" class="w-full btn-gold py-3 rounded-xl mt-4 font-bold">
                        <i class="fab fa-paypal mr-2"></i> Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ PayPal
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Orders Modal -->
    <div id="ordersModal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="modal-backdrop absolute inset-0" onclick="document.getElementById('ordersModal').classList.add('hidden')"></div>
        <div class="min-h-screen flex items-center justify-center p-4">
            <div class="bg-[#1A1A1A] w-full max-w-lg rounded-2xl gold-border p-4">
                <h3 class="font-bold gold-gradient mb-4" data-translate="myOrders">Ø³ÙØ§Ø±Ø´Ø§Øª Ù…Ù†</h3>
                <div id="ordersList" class="space-y-3"></div>
            </div>
        </div>
    </div>

    <script>
        const texts = {
            fa: { siteName: 'Ø±Ø³ØªÙˆØ±Ø§Ù† Ø±ÙˆÛŒØ§Ù„', cart: 'Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯', checkout: 'ØªÚ©Ù…ÛŒÙ„ Ø®Ø±ÛŒØ¯', orderForm: 'Ø§Ø·Ù„Ø§Ø¹Ø§Øª', myOrders: 'Ø³ÙØ§Ø±Ø´Ø§Øª Ù…Ù†' },
            en: { siteName: 'Royal Restaurant', cart: 'Cart', checkout: 'Checkout', orderForm: 'Details', myOrders: 'My Orders' },
            ar: { siteName: 'Ù…Ø·Ø¹Ù… Ø±ÙˆÙŠØ§Ù„', cart: 'Ø§Ù„Ø³Ù„Ø©', checkout: 'Ø§Ù„Ø¯ÙØ¹', orderForm: 'Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', myOrders: 'Ø·Ù„Ø¨Ø§ØªÙŠ' }
        };
        let lang = localStorage.getItem('lang') || 'fa';
        let products = [], categories = [], cart = JSON.parse(localStorage.getItem('cart')) || [];
        let myOrders = JSON.parse(localStorage.getItem('myOrders')) || [];

        function setLang(l) {
            lang = l; localStorage.setItem('lang', l);
            document.getElementById('currLang').textContent = l === 'fa' ? 'ğŸ‡®ğŸ‡·' : (l === 'en' ? 'ğŸ‡¬ğŸ‡§' : 'ğŸ‡¸ğŸ‡¦');
            document.documentElement.dir = l === 'en' ? 'ltr' : 'rtl';
            document.querySelectorAll('[data-translate]').forEach(e => e.textContent = texts[l][e.dataset.translate]);
            render();
        }
        function toggleLang() { setLang(lang === 'fa' ? 'en' : (lang === 'en' ? 'ar' : 'fa')); }

        async function init() {
            const res = await fetch('/api/data');
            const data = await res.json();
            products = data.products; categories = data.categories;
            setLang(lang);
            updateCart();
        }

        function render() {
            document.getElementById('cats').innerHTML = categories.map(c => 
                `<button onclick="filter('${c.id}')" class="px-4 py-2 rounded-full gold-border whitespace-nowrap">${c.name[lang]}</button>`
            ).join('');
            filter('all');
        }

        function filter(cid) {
            const list = cid === 'all' ? products : products.filter(p => p.category === cid);
            document.getElementById('prods').innerHTML = list.map(p => `
                <div class="bg-[#1A1A1A] rounded-xl gold-border overflow-hidden">
                    <img src="${p.image}" class="w-full h-32 object-cover">
                    <div class="p-3">
                        <h4 class="font-bold truncate">${p.name[lang]}</h4>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-[#D4AF37] text-sm">${p.price} OMR</span>
                            <button onclick="addCart('${p.id}')" class="btn-gold px-2 py-1 rounded-lg text-xs"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function addCart(id) {
            const item = cart.find(x => x.id === id);
            if(item) item.quantity++; else cart.push({id, quantity: 1});
            updateCart();
        }

        function updateCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            document.getElementById('cartBadge').textContent = cart.reduce((a,b)=>a+b.quantity,0);
            document.getElementById('cartBadge').classList.toggle('hidden', cart.length===0);
        }

        function showCart() {
            document.getElementById('cartItems').innerHTML = cart.map(item => {
                const p = products.find(x => x.id === item.id);
                return `<div class="flex justify-between items-center bg-black/30 p-2 rounded mb-2">
                    <span>${p.name[lang]}</span>
                    <div class="flex gap-2 items-center">
                        <span class="text-[#D4AF37]">${item.quantity}x</span>
                        <button onclick="cart=cart.filter(x=>x.id!=='${item.id}');updateCart();showCart()" class="text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('') || '<div class="text-center text-gray-500">Ø®Ø§Ù„ÛŒ</div>';
            document.getElementById('cartModal').classList.remove('hidden');
        }

        function getLoc() {
            navigator.geolocation.getCurrentPosition(p => 
                document.getElementById('locInput').value = `${p.coords.latitude}, ${p.coords.longitude}`
            );
        }

        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if(cart.length === 0) return alert('Ø³Ø¨Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª');
            const btn = document.getElementById('payBtn');
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ...';
            
            const data = {
                customer: Object.fromEntries(new FormData(e.target)),
                items: cart
            };

            try {
                const res = await fetch('/api/order/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if(!res.ok) throw new Error();
                const json = await res.json();
                window.location.href = json.approval_url;
            } catch {
                alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯Ø±Ú¯Ø§Ù‡');
                btn.innerHTML = 'ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯';
            }
        });

        async function showOrders() {
            document.getElementById('ordersModal').classList.remove('hidden');
            const list = document.getElementById('ordersList');
            list.innerHTML = '<div class="text-center">...</div>';
            
            let html = '';
            for(const oid of myOrders) {
                try {
                    const res = await fetch(`/api/order/${oid}`);
                    if(res.ok) {
                        const o = await res.json();
                        html += `<div class="bg-black/40 p-3 rounded border border-white/10">
                            <div class="flex justify-between"><span>#${o.id}</span><span class="${o.status==='confirmed'?'text-green-500':'text-yellow-500'}">${o.status}</span></div>
                            <div class="text-sm text-gray-400 mt-1">${o.total_omr.toFixed(2)} OMR</div>
                        </div>`;
                    }
                } catch {}
            }
            list.innerHTML = html || 'Ø³ÙØ§Ø±Ø´ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯';
        }

        function closeCart() { document.getElementById('cartModal').classList.add('hidden'); }
        function showCheckout() { closeCart(); document.getElementById('checkoutModal').classList.remove('hidden'); }
        function closeCheckout() { document.getElementById('checkoutModal').classList.add('hidden'); }

        init();
    </script>
</body>
</html>